---
title: The BioDT Recreational Potential Model
subtitle: Demonstration
authors:
  - name: "Joe Marsh Rossney <a href='https://github.com/jmarshrossney' style='color: black'><i class='bi bi-github'></i></a>"
    affiliations: UK Centre for Ecology & Hydrology
    orcid: 0000-0002-8082-8566
  - name: "Maddalena Tigli <a href='https://github.com/madtig' style='color: black'><i class='bi bi-github'></i></a>"
    orcid: 0000-0001-8083-0589

date: last-modified
date-format: long
---

### Basic usage

These instructions cover setup and basic usage of the RP model.

It is assumed that the user is familiar with the following:

- Installing `R` packages
- Executing lines of `R` code in interactive sessions
- Running `R` scripts

More detailed instructions for developers can be found in the [`README.md`](https://github.com/BioDT/uc-ces-recreation/blob/main/README.md) file in the repository.

### Prerequisites

- R version 4.4.x
- Ensure you have either `remotes` or `devtools` installed (using e.g. `install.packages` or `renv::install`)
- It is recommended to perform the following steps using an R envirnoment managed by [`renv`](https://rstudio.github.io/renv/)
- There are certain C++ libraries that are required by the R packages, and need to be installed on the system. Most importantly is the GDAL library.

```{r}
install.packages("remotes")
```

### Installation

1. Install the package:

```{r}
remotes::install_github("BioDT/uc-ces-recreation")
```

2. Download the data:

```{r}
options(timeout=1200)
biodt.recreation::download_data()
```

### Usage

3. Run the app:

```{r}
#| eval: false

biodt.recreation::run_app()
```

4. Use the package in a script

```{r}
library(terra)
library(biodt.recreation)

persona_file <- get_preset_persona_file()
persona_df <- read_persona_csv(persona_file)
persona_df

hr_persona <- load_persona(persona_file, "Hard_Recreationalist")
hr_persona
```

```{r}
# Replace this with get_data_dir() if you have downloaded the full dataset!
data_dir <- get_example_data_dir()
```

### Load/create a persona

```{r}
persona <- get_example_persona()
persona
```

### Select an area of interest

```{r}
bbox <- get_example_bbox()
bbox
```

### Compute a single component

```{r}
fips_n <- compute_fips_n(persona, bbox, data_dir)
terra::plot(fips_n)
```

```{r}
water <- compute_component("Water", persona, bbox, data_dir)
terra::plet(water)
```

### Compute all layers

```{r}
layers <- compute_potential(persona, bbox, data_dir)
names(layers)

terra::plot(layers[["Recreational_Potential"]])
```




We demonstrate the RP Model applied to the Bush Estate area (nearby Edinburgh) using two contrasting personas:

1. **_Hard Recreationalist_**: this persona values remote, challenging environments and avoids built-up or highly managed areas.
2. **_Soft Recreationalist_**: this persona values tranquil, accessible landscapes and natural water features, and avoids steep or harsh terrain.

==TODO: when/how where these personas created?==
These personas are provided in the model as 'presets'; users may customise them or simply use them out-of-the-box.

The resulting maps illustrate how different preferences lead to different areas being highlighted for recreational value.

The source code used to produce these maps can be found in the [demo notebook](demo.html).

```{r, echo=FALSE}
library(magrittr)
library(biodt.recreation)

source("functions_report.R")

water <- terra::rast(system.file("extdata", "rasters", "Bush", "original", "Water.tif", package="biodt.recreation"))

slsra <- terra::rast(system.file("extdata", "rasters", "Bush", "SLSRA.tif", package="biodt.recreation"))

fips_n <- terra::rast(system.file("extdata", "rasters", "Bush", "FIPS_N.tif", package="biodt.recreation"))

fips_i <- terra::rast(system.file("extdata", "rasters", "Bush", "original", "FIPS_I.tif", package="biodt.recreation"))



# the box of bush estate
e <- terra::ext(water)
coords <- matrix(c(
  e$xmin, e$ymin,
  e$xmax, e$ymin,
  e$xmax, e$ymax,
  e$xmin, e$ymax,
  e$xmin, e$ymin # close polygon
), ncol = 2, byrow = TRUE)
bbox_poly <- terra::vect(coords,
  type = "polygons",
  crs = terra::crs(water)
) %>%
  sf::st_as_sf() %>%
  sf::st_transform(crs = 4326)

base_map <- 
  leaflet::leaflet() %>%
  leaflet::addProviderTiles("OpenStreetMap.Mapnik", options = leaflet::providerTileOptions(zIndex = 0, noWrap = TRUE), group = "Streets") %>%
  leaflet::addProviderTiles("Esri.WorldImagery", options = leaflet::providerTileOptions(zIndex = 0, noWrap = TRUE), group = "Satellite") %>%
  leaflet::addPolygons(
    data = bbox_poly,
    color = "black",
    weight = 3,
    fill = FALSE
  ) 

```

### Hard Recreationalist

The strongest preferences of the *Hard Recreationalist* persona are highlighted in ==TABLE==

```{r, echo=FALSE, message=FALSE}

hard_recr <- 
  data.frame(get_example_persona())%>%
  tibble::rownames_to_column(var = "Name")%>%
  dplyr::select(Name,
                Score = `get_example_persona..`)

meaningful_scores <- summarise_persona_scores(hard_recr)
  
knitr::kable(meaningful_scores,format = "html",
             caption = "Features scored the highest and the lowest in the hard recreationalist persona")
```



```{r, echo=FALSE, warning=FALSE, results='hide', message = FALSE}
hard_recreationalist <- get_example_persona()
bush_estate <- get_example_bbox()
data_dir <- get_example_data_dir()

# Compute all layers
layers_HR <- compute_potential(hard_recreationalist,
                            bush_estate,
                            data_dir)
```

```{r, echo=FALSE }
build_rp_map(base_map, RP_output = layers_HR)
```

### Soft Recreationalist

The strongest preferences of the *Soft Recreationalist* persona are highlighted in ==TABLE==

```{r, echo=FALSE}

soft_recr <- 
  read.csv(system.file("extdata", "personas", "presets.csv", package="biodt.recreation")) %>%
  dplyr::select(Name = index,
                Score = Soft_Recreationalist)

meaningful_scores <- summarise_persona_scores(soft_recr)
  
knitr::kable(meaningful_scores,format = "html",
             caption = "Features scored the highest and the lowest in the soft recreationalist persona")
```


```{r, echo=FALSE, warning=FALSE, results='hide', message = FALSE}
soft_recreationalist <- 
  load_persona(get_preset_persona_file(), "Soft_Recreationalist")
  
# Compute all layers
layers_SR <- compute_potential(soft_recreationalist,
                            bush_estate,
                            data_dir)
```

```{r, echo=FALSE}
build_rp_map(base_map, RP_output = layers_SR)
```
